数据库事务需满足ACID（原子性、一致性、隔离性、持久性）四个特性

- 原子性（Atomicity）事务作为整体来执行，要么全部执行，要么全不执行
- 一致性（Consistency）事务确保数据从一个一致的状态变为另一个一致的状态
- 隔离性（Isolation）多个事务并发执行时，一个事务的执行不影响其他事务的执行
- 持久性（Durability）已提交的事务修改数据会被持久保存

在单一数据节点中，事务仅限于对单一数据库资源的访问控制，称之为本地事务；关系型数据库虽然对本地事务提供了完美的 `ACID` 原生支持。 但在分布式的场景下，它却成为系统性能的桎梏

#### 本地事务

不开启任何分布式事务管理器的前提下，让每个数据节点各自管理自己的事务。它们之间==没有协调以及通信==的能力，也并不互相知晓其他数据节点事务的成功与否。 本地事务在性能方面无任何损耗，但在==强一致性==以及==最终一致性==方面则力不从心。

#### 两阶段提交

==XA协议==最早的分布式事务模型是由 `X/Open` 国际联盟提出的 `X/Open Distributed Transaction Processing (DTP)` 模型，简称 XA 协议。

基于XA协议的实现的分布式事务对==业务入侵小==，最大优势就是对==使用方透明==，用户可以像使用本地事务一样使用基于XA协议的分布式事务，XA协议严格保证==ACID==特性

严格保障ACID特性是把双刃剑。事务执行过程中将锁定全部所需资源，更加适用于执行时间确定的短事务。对于长事务，整个事务期间对数据的独占，将导致对热点数据依赖的业务并发性能衰退明显。因此，高并发性能至上场景，不适合使用基于XA协议的分布式事务。

#### 柔性事务

将实现了==ACID==特性的事务 称之为刚性事务，那基于==BASE==特性的事务称之为==柔性事务==。柔性事务是由基本可用、柔性状态和最终一致性组成。

- 基本可用（Basically Available）保证分布式事务参与方不一定同时在线
- 柔性状态（Soft state）则允许系统状态**更新有一定的延时**，这个延时对客户来说不一定能够察觉
- 最终一致性（Eventually consistent）通常是通过==消息传递==的方式保证系统的最终一致性

![image-20210727134742890](D:\self-study\learnNotes\分布式事务.assets\image-20210727134742890.png)

基于XA的强一致事务使用相对简单，但是无法很好的应对互联网的高并发或复杂系统的长事务场景；柔性事务则需要开发者对应用进行改造，接入成本非常高，并且需要开发者自行实现资源锁定和反向补偿。

### XA两阶段事务

采用AP（应用程序）、TM（事务管理器）和RM（资源管理器）来保证分布式事务的强一致性。其中RM和TM间通过XA协议双向通信。TM可以收集**所有分支事务的准备结果**，并于最后进行原子提交，以保证事务的强一致性。

![image-20210727135356412](D:\self-study\learnNotes\分布式事务.assets\image-20210727135356412.png)

### SEATA柔性事务

Seata AT事务模型包括TM（事务管理器）、RM（资源管理器）和TC（事务协调器）。TC独立部署。TM和RM以jar包同业务一同部署，它们同TC建立长链接，整个事务周期内，保持远程通信。==TM==是全局事务的发起方，==负责全局事务的开启，提交和回滚==。==RM==全局事务参与者，负责==分支事务的执行结果上报==，通过TC的协调进行分支事务的提交和回滚。

Seata 管理的分布式事务的典型生命周期：

1. TM 要求 TC 开始一个全新的全局事务。TC 生成一个代表该全局事务的 XID。
2. XID 贯穿于微服务的整个调用链。
3. 作为该 XID 对应到的 TC 下的全局事务的一部分，RM 注册本地事务。
4. TM 要求 TC 提交或回滚 XID 对应的全局事务。
5. TC 驱动 XID 对应的全局事务下的所有分支事务完成提交或回滚。

![image-20210727141553022](D:\self-study\learnNotes\分布式事务.assets\image-20210727141553022.png)

